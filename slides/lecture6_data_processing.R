
## ----, echo=FALSE, results='hide'----------------------------------------
# increase number of characters to display
options(width=80)


## ------------------------------------------------------------------------
setwd(file.path('..','datasets'))
haart <- read.csv("haart.csv")


## ------------------------------------------------------------------------
head(haart)


## ------------------------------------------------------------------------
str(haart)


## ------------------------------------------------------------------------
attach(haart)
weight[1:20]


## ------------------------------------------------------------------------
detach(haart)
tryCatch(weight, error=function(e) e)


## ------------------------------------------------------------------------
str(haart[,'init.reg'])


## ------------------------------------------------------------------------
(x <- factor(rbinom(20, 4, 0.5)))


## ------------------------------------------------------------------------
levels(x) <- 0:5
table(x)


## ------------------------------------------------------------------------
x[4] <- 17


## ------------------------------------------------------------------------
haart[,'gender'] <- factor(haart[,'male'])


## ------------------------------------------------------------------------
levels(haart[,'gender']) <- c("female","male")


## ------------------------------------------------------------------------
haart[,'gender'] <- factor(haart[,'male'], labels=c("female","male"))
str(haart[,'gender'])


## ------------------------------------------------------------------------
haart[1:20,'age']
# or equivalently ...
haart[[2]][1:20]


## ------------------------------------------------------------------------
x <- haart[,c("male", "age", "death")]
head(x)
# comma not required
x1 <- haart[c("male", "age", "death")]
identical(x, x1)


## ------------------------------------------------------------------------
y <- x[x[,'male'] == 1,]
head(y)


## ------------------------------------------------------------------------
y <- haart[haart[,'male'] == 1, c("male", "age", "death")]
head(y)


## ------------------------------------------------------------------------
haart[,'last.visit'] <- as.POSIXct(haart[,'last.visit'], format="%m/%d/%y")
haart[,'init.date'] <- as.POSIXct(haart[,'init.date'], format="%m/%d/%y")
haart[,'date.death'] <- as.POSIXct(haart[,'date.death'], format="%m/%d/%y")


## ------------------------------------------------------------------------
(haart[,'last.visit'] - haart[,'init.date'])[1:50]


## ------------------------------------------------------------------------
difftime(haart[,'last.visit'], haart[,'init.date'], units="days")[seq(20)]


## ------------------------------------------------------------------------
(haart$time.diff <- as.Date(haart[,'last.visit']) - as.Date(haart[,'init.date']))[seq(20)]


## ------------------------------------------------------------------------
haart[,'age_group'] <- cut(haart[,'age'], c(min(haart[,'age']), 30, 50, max(haart[,'age'])))


## ------------------------------------------------------------------------
table(haart[,'age_group'])


## ------------------------------------------------------------------------
table(cut(haart[,'age'], c(min(haart[,'age']), 30, 50, max(haart[,'age'])), right=FALSE))


## ------------------------------------------------------------------------
word <- 'processing'
class(word)


## ------------------------------------------------------------------------
word[1]
length(word)


## ------------------------------------------------------------------------
nchar(word)
substr(word, 1, 3)
substr(word, 3, 5)


## ------------------------------------------------------------------------
sentence <- "R provides a separate set of functions to process text"
(words <- strsplit(sentence, " "))


## ------------------------------------------------------------------------
paste(unlist(words), collapse=" ")


## ------------------------------------------------------------------------
toupper(word)


## ------------------------------------------------------------------------
titlecase <- function(str) {
    str <- tolower(str)
    substr(str,1,1) <- toupper(substr(str,1,1))
    str
}

titlecase(word)


## ------------------------------------------------------------------------
(rna <- chartr('atcg', 'uagc', 'aagcgtctac'))


## ------------------------------------------------------------------------
words
charmatch('fun', unlist(words))
charmatch('foo', unlist(words))
charmatch('pr', unlist(words))


## ------------------------------------------------------------------------
head(haart[,'init.reg'])
table(haart[,'init.reg'])


## ------------------------------------------------------------------------
init.reg <- as.character(haart[,'init.reg'])


## ------------------------------------------------------------------------
(haart[['init.reg_list2']] <- strsplit(init.reg, ","))[1:3]


## ------------------------------------------------------------------------
tapply(haart[,'weight'], haart[,'male'], mean, na.rm=TRUE)


## ------------------------------------------------------------------------
tapply(haart[,'weight'], haart[,c("male", "aids")], mean, na.rm=TRUE)


## ------------------------------------------------------------------------
tapply(haart[,'weight'], haart[,c("male", "aids", "death")], mean, na.rm=TRUE)


## ------------------------------------------------------------------------
(haart_means <- lapply(haart[,4:6], mean, na.rm=TRUE))
haart_means$weight


## ------------------------------------------------------------------------
sapply(haart, is.numeric)


## ------------------------------------------------------------------------
sapply(haart[,c("cd4baseline", "weight", "hemoglobin")], scale)[1:5,]


## ------------------------------------------------------------------------
library(parallel)
detectCores()


## ------------------------------------------------------------------------
haart_means <- mclapply(haart[,4:6], mean, na.rm=TRUE)


## ------------------------------------------------------------------------
d4t_index <- sapply(haart$init.reg_list, function(x) 'D4T' %in% x)
haart_D4T <- haart[d4t_index, ]
head(haart_D4T)


## ------------------------------------------------------------------------
unlist(haart$init.reg_list)[seq(50)]


## ------------------------------------------------------------------------
(all_drugs <- unique(unlist(haart$init.reg_list)))


## ------------------------------------------------------------------------
sapply(haart$init.reg_list, function(x) 'D4T' %in% x)[seq(50)]


## ------------------------------------------------------------------------
for (drug in all_drugs) {
    sapply(haart$init.reg_list, function(x) drug %in% x)
}


## ------------------------------------------------------------------------
reg_drugs <- matrix(FALSE, nrow=nrow(haart), ncol=length(all_drugs))
for(i in seq_along(all_drugs)) {
  reg_drugs[,i] <- sapply(haart$init.reg_list, function(x) all_drugs[i] %in% x)
}
head(reg_drugs)


## ------------------------------------------------------------------------
reg_drugs <- data.frame(reg_drugs)
names(reg_drugs) <- all_drugs


## ------------------------------------------------------------------------
haart_merged <- cbind(haart, reg_drugs)
head(haart_merged)


## ------------------------------------------------------------------------
haart_m30 <- subset(haart, gender=="male" & age>30, select=c(death, weight, hemoglobin))
head(haart_m30)


## ------------------------------------------------------------------------
!is.na(haart[1:50,'weight'])
head(haart[!is.na(haart[,'weight']),])


## ------------------------------------------------------------------------
complete.cases(haart[,1:12])[seq(50)]
haart[complete.cases(haart[,1:12]),]


## ------------------------------------------------------------------------
order(haart[,'init.date'], haart[,'last.visit'])[seq(50)]


## ------------------------------------------------------------------------
haart_sorted <- haart[order(haart[,'init.date'], haart[,'last.visit']),]
head(haart_sorted)


## ------------------------------------------------------------------------
dim(rbind(haart[1:500,], haart[501:1000,]))


## ------------------------------------------------------------------------
tryCatch(dim(rbind(haart[1:500,], haart[501:1000,1:10])), error=function(e) e)


## ------------------------------------------------------------------------
df1 <- data.frame(a=c(1,2,4,5,6),x=c(9,12,14,21,8))
df2 <- data.frame(a=c(1,3,4,6),y=c(8,14,19,2))
merge(df1, df2)


## ------------------------------------------------------------------------
merge(df1, df2, all=TRUE)


## ------------------------------------------------------------------------
merge(df1, df2, all.x=TRUE)
merge(df1, df2, all.y=TRUE)

